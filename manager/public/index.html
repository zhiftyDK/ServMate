<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ServMate Dashboard</title>
  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Fetch agents every 5 seconds
    async function fetchAgents() {
      try {
        const res = await fetch('/api/agents');
        const data = await res.json();
        window.agents = data;  // Store agents globally
        renderAgents(data);
      } catch (err) {
        document.getElementById('agents').innerHTML = '<p class="text-danger">Error loading agents.</p>';
      }
    }

    // Helper function to format uptime in d h m format
    function formatUptime(secs) {
      const d = Math.floor(secs / (3600 * 24));
      const h = Math.floor((secs % (3600 * 24)) / 3600);
      const m = Math.floor((secs % 3600) / 60);
      return `${d}d ${h}h ${m}m`;
    }

    // Function to check if the agent is online
    function isAgentOnline(lastSeen) {
      const now = Date.now();
      const OFFLINE_TIMEOUT = 15000;  // 15 seconds
      return now - lastSeen < OFFLINE_TIMEOUT;
    }

    // Render agents
    function renderAgents(agents) {
      const container = document.getElementById('agents');
      const agentKeys = Object.keys(agents);
      if (agentKeys.length === 0) {
        container.innerHTML = '<p>No agents found.</p>';
        return;
      }

      container.innerHTML = ''; // Clear previous agents

      agentKeys.forEach(id => {
        const a = agents[id];

        const cpuLoad = a.cpu_load ?? '?';
        const usedMemMB = a.used_mem ? Math.round(a.used_mem / (1024 * 1024)) : '?';
        const totalMemMB = a.total_mem ? Math.round(a.total_mem / (1024 * 1024)) : '?';
        const diskInfo = a.disk_info ? a.disk_info.map(d => {
          const pct = ((d.used / d.size) * 100).toFixed(1);
          return `${d.fs} ${pct}%`;
        }).join(', ') : 'n/a';
        const uptimeStr = a.uptime ? formatUptime(a.uptime) : '?';
        
        // Checking if agent is online or offline
        const agentStatus = isAgentOnline(a.last_seen) ? 'üü¢ ONLINE' : 'üî¥ OFFLINE';

        const cardHTML = `
          <div class="col-md-4 mb-4">
            <div class="card" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#agentModal" data-agent-id="${id}">
              <div class="card-body">
                <h5 class="card-title">${a.hostname} (${a.ip})</h5>
                <p class="text-muted">${agentStatus}</p>
                <p class="card-text"><strong>CPU:</strong> ${a.cpu_model} - ${a.cpu_cores} cores - ${cpuLoad}% load</p>
                <p class="card-text"><strong>RAM:</strong> ${usedMemMB}MB / ${totalMemMB}MB</p>
                <p class="card-text"><strong>Disk:</strong> ${diskInfo}</p>
              </div>
            </div>
          </div>
        `;

        container.innerHTML += cardHTML;
      });
    }

    // Show details in modal when clicking card
    document.addEventListener('click', function (e) {
      if (e.target && e.target.closest('.card')) {
        const agentId = e.target.closest('.card').getAttribute('data-agent-id');
        const agent = window.agents[agentId];
        const modal = new bootstrap.Modal(document.getElementById('agentModal'));

        // Set modal content dynamically
        document.getElementById('modalTitle').innerText = `${agent.hostname} (${agent.ip})`;
        document.getElementById('modalCpu').innerText = `CPU: ${agent.cpu_model} - ${agent.cpu_cores} cores - ${agent.cpu_load}% load`;
        document.getElementById('modalRam').innerText = `RAM: ${Math.round(agent.used_mem / (1024 * 1024))}MB / ${Math.round(agent.total_mem / (1024 * 1024))}MB`;
        document.getElementById('modalDisk').innerText = `Disk: ${agent.disk_info.map(d => `${d.fs} ${(d.used / d.size) * 100}%`).join(', ')}`;
        document.getElementById('modalUptime').innerText = `Uptime: ${formatUptime(agent.uptime)}`;

        // Automatically show the modal
        modal.show();
      }
    });

    fetchAgents();
    setInterval(fetchAgents, 5000);
  </script>
</head>
<body>

  <!-- Header -->
  <header class="bg-primary text-white p-4">
    <h1 class="text-center">üåê ServMate Dashboard</h1>
  </header>

  <!-- Main content -->
  <main class="container mt-4">
    <div id="agents" class="row">
      <!-- Agent cards will appear here -->
      <p>Loading agents...</p>
    </div>
  </main>

  <!-- Agent Modal -->
  <div class="modal fade" id="agentModal" tabindex="-1" aria-labelledby="agentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Agent Details</h5>
          <!-- Close button with correct bootstrap functionality -->
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="modalCpu"></p>
          <p id="modalRam"></p>
          <p id="modalDisk"></p>
          <p id="modalUptime"></p>
        </div>
        <div class="modal-footer">
          <!-- Button that will close the modal -->
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
